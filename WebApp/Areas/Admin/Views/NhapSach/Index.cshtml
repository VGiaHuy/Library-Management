@{
    ViewBag.Title = "Nhập sách";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<!-- Hiển thị danh sách NhanViens -->
<section class="content">
    <div class="container-fluid pt-4">
        <div class="row">

            <!-- Tạo phiếu nhập sách -->
            <div class="col-8" style="height: 80vh;">
                <div class="card" style="height: 100%;">
                    <div class="card-header bg-light shadow-sm rounded">
                        <!-- Hàng trên -->
                        <div class="row align-items-center justify-content-between mb-3">
                            <div class="col-md-4 text-center">
                                <h3 class="text-primary font-weight-bold mb-0">Nhập Sách</h3>
                            </div>
                            <div class="col-md-8 text-center">
                                <button type="submit"
                                        class="btn btn-primary me-2"
                                        id="taoPhieuNhap"
                                        onclick="taoPhieuNhap()">
                                    Tạo phiếu nhập
                                </button>
                                <button type="button"
                                        class="btn btn-warning me-2"
                                        id="lamMoiButton"
                                        onclick="lamMoi()">
                                    Làm mới
                                </button>
                                <button type="button"
                                        class="btn btn-success"
                                        id="themSachMoiButton"
                                        onclick="showInputThemSachMoi()">
                                   Thêm sách mới
                                </button>
                            </div>
                        </div>

                        <!-- Hàng dưới -->
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                             
                                <div class="d-flex justify-content-center align-items-center">
                                    <input type="file"
                                           id="fileExcel"
                                           accept=".xlsx, .xls"
                                           class="form-control w-75">
                                    <button class="btn btn-secondary ms-3"
                                            onclick="uploadExcel()">
                                        <i class="fas fa-upload me-1"></i>Tải lên
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" style="overflow-y: auto;">
                        <form>

                            <div class="form-row">
                                <!--Mã nhà cung cấp-->
                                <div class="form-group col">
                                    <label for="name">Mã NCC:</label>
                                    <input type="text" class="form-control" id="MaNCC" name="MaNCC" readonly>
                                </div>

                                <!--Mã nhân viên-->
                                <div class="form-group col">
                                    <label for="MaNhanVien">Mã NV:</label>
                                    <input type="text" class="form-control" id="MaNhanVien" name="MaNhanVien" value="4" readonly>
                                </div>

                                <!--Ngày nhập sách-->
                                <div class="form-group col">
                                    <label for="NgayNhap">Ngày nhập:</label>
                                    <input type="date" class="form-control" id="NgayNhap" name="NgayNhap" readonly>
                                </div>

                                <!--SDT nhà cc-->
                                <div class="form-group col">
                                    <label for="SDT">Số điện thoại:</label>
                                    <input type="text" class="form-control" id="SDT" name="SDT" readonly>
                                </div>
                            </div>

                            <!--Tên nhà cung cấp-->
                            <div class="form-row">
                                <div class="form-group col">
                                    <label for="TenNCC">Tên nhà cung cấp:</label>
                                    <input type="text" class="form-control" id="TenNCC" name="TenNCC" readonly>
                                </div>

                            </div>

                            <!-- Địa chỉ-->
                            <div class="form-row">
                                <div class="form-group col-8">
                                    <label for="DiaChi">Địa chỉ:</label>
                                    <input type="text" class="form-control" id="DiaChi" name="DiaChi" readonly>
                                </div>

                                <div class="form-group col-4">
                                    <label for="tongTienPhuThu">Tổng tiền:</label>
                                    <input type="text" class="form-control" id="tongTienPhuThu" name="tongTienPhuThu" readonly>

                                </div>

                            </div>

                            <!--Danh sách sách nhập-->
                            <div class="text-center">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Mã</th>
                                            <th>Tên</th>
                                            <th>T/loại</th>
                                            <th>T/giả</th>
                                            <th>N/ngữ</th>
                                            <th>NhàXB</th>
                                            <th>NămXB</th>
                                            <th>S/Lượng</th>
                                            <th>Giá/1</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="danhSachSachNhap">
                                       
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sách và Thông tin nhà cung cấp -->
            <div class="col-4">
                <div class="card">
                    <div class="card-header">
                        <!--btn thông tin nhà cung cấp-->
                        <button id="thongTinNCCButton" class="btn btn-primary" onclick="changeTableShow(thongTinNCCTable, thongTinSachTable)">
                            Thông Tin NCC
                        </button>

                        <!--btn thông tin sách-->
                        <button id="thongTinSachButton" class="btn btn-primary" onclick="changeTableShow(thongTinSachTable, thongTinNCCTable)">
                            Sách có sẵn
                        </button>

                        <!--btn thêm nhà cung cấp-->
                        <button id="themNCCButton" class="btn btn-secondary" onclick="btnShowModalThemNCC()">
                            Thêm NCC
                        </button>


                    </div>

                   
                    <!--<!--Body table sách-->
                    <div class="card-body table-responsive p-0"
                         style="height: 72vh" id="thongTinSachTable">
                        <table id="danhSachSach"  class="table table-head-fixed table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th>Mã</th>
                                    <th>Tên sách</th>
                                    <th>Nhập</th>
                                </tr>
                            </thead>
                            
                        </table>
                    </div>
                    <!--Body table ncc-->
                    <div class="card-body table-responsive p-0"
                         style="height: 72vh" id="thongTinNCCTable">
                        <table id="danhSachNCC" class="table table-head-fixed table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th>Mã</th>
                                    <th>Tên NCC</th>
                                    <th>SDT</th>
                                    <th>Địa chỉ</th>
                                </tr>
                            </thead>
                            
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal hiển thị lỗi -->
<!-- Modal Lỗi -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center w-100" id="errorModalLabel">Lỗi khi nhập sách</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
        </div>
    </div>
</div>

<!-- Modal hiển thị chi tiết sách -->
<div class="modal fade bd-example-modal-lg" id="showChiTietSachModal" tabindex="-1" role="dialog" aria-labelledby="showChiTietSachModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog modal-lg" role="document">
        <div class="modal-content">

            <!-- Header -->
            <div class="modal-header text-center">
                <h4 class="modal-title w-100 text-blue" style="font-weight: bold;" id="">Chi Tiết Sách</h4>
            </div>

            <!-- Body -->
            <form class="modal-body p-4">
                <div class="form-row">
                    <!--Mã sách-->
                    <div class="form-group col">
                        <label>Mã sách:</label>
                        <input class="form-control" id="maSachModal" readonly>
                    </div>

                    <!--Số lượng hiện tại-->
                    <div class="form-group col">
                        <label>S/Lượng hiện tại:</label>
                        <input class="form-control" id="soLuongHienTaiModal" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <!--Tên sách-->
                    <div class="form-group col">
                        <label>Tên sách:</label>
                        <input class="form-control" id="tenSachModal" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <!--Thể loại-->
                    <div class="form-group col">
                        <label>Thể loại:</label>
                        <input class="form-control" id="theLoaiModal" readonly>
                    </div>

                    <!--ngôn ngữ-->
                    <div class="form-group col">
                        <label>Ngôn ngữ:</label>
                        <input class="form-control" id="ngonNguModal" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <!--Tác giả-->
                    <div class="form-group col">
                        <label>Tác giả:</label>
                        <input class="form-control" id="tacGiaModal" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <!--Nhà xuất bản-->
                    <div class="form-group col">
                        <label>Nhà xuất bản:</label>
                        <input class="form-control" id="nhaXuatBanModal" readonly>
                    </div>

                    <!--Năm xuất bản-->
                    <div class="form-group col">
                        <label>Năm xuất bản:</label>
                        <input class="form-control" id="namXuatBanModal" readonly>
                    </div>
                </div>

            </form>

            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"> Đóng </button>
                <button type="button" class="btn btn-primary" onclick="nhapThemSoLuongVaGiaSach()"> Thêm sách </button>
            </div>

        </div>
    </div>
</div>

<!-- Modal nhập thông tin sách mới-->
<div class="modal fade bd-example-modal-lg" id="inputSachModal" tabindex="-1" role="dialog" aria-labelledby="inputSachModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog modal-lg" role="document">
        <div class="modal-content">

            <!-- Header -->
            <div class="modal-header text-center">
                <h4 class="modal-title w-100 text-blue" style="font-weight: bold;" id="">Nhập thông tin Sách</h4>
            </div>

            <!-- Body -->
            <form class="modal-body p-4">

                <div class="form-row">
                    <!--Tên sách-->
                    <div class="form-group col">
                        <label>Tên sách:</label>
                        <input class="form-control" id="inputTenSachModal">
                    </div>

                    <!--Tác giả-->
                    <div class="form-group col">
                        <label>Tác giả:</label>
                        <input class="form-control" id="inputTacGiaModal">
                    </div>
                </div>

                <div class="form-row">
                    <!--Thể loại-->
                    <div class="form-group col">
                        <label>Thể loại:</label>
                        <select class="form-control" id="inputTheLoaiModal">
                            <option>Chọn thể loại</option>
                            <option value="Truyện ngắn">Truyện ngắn</option>
                            <option value="Truyện thiếu nhi">Truyện thiếu nhi</option>
                            <option value="Tiểu thuyết">Tiểu thuyết</option>
                            <option value="Ngôn tình">Ngôn tình</option>
                            <option value="Sách giáo khoa">Sách giáo khoa</option>
                            <option value="Sách tham khảo">Sách tham khảo</option>
                            <option value="Văn học">Văn học</option>
                            <option value="Sách ngoại ngữ">Sách ngoại ngữ</option>
                            <option value="Kỹ năng sống">Kỹ năng sống</option>
                        </select>
                    </div>

                    <!--ngôn ngữ-->
                    <div class="form-group col">
                        <label>Ngôn ngữ:</label>
                        <select class="form-control" id="inputNgonNguModal">
                            <option>Chọn ngôn ngữ</option>
                            <option value="Tiếng việt">Tiếng việt</option>
                            <option value="Tiếng anh">Tiếng anh</option>
                            <option value="Tiếng hàn">Tiếng hàn</option>
                            <option value="Tiếng trung">Tiếng trung</option>
                            <option value="Tiếng pháp">Tiếng pháp</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <!--Nhà xuất bản-->
                    <div class="form-group col">
                        <label>Nhà xuất bản:</label>
                        <input class="form-control" id="inputNhaXuatBanModal">
                    </div>

                        <!--Năm xuất bản-->
                        <div class="form-group col">
                            <label for="inputNamXuatBanModal">Năm xuất bản:</label>
                            <select class="form-control" id="inputNamXuatBanModal" ">
                                <option value="">Chọn năm xuất bản</option>
                                @* <script>
                                    var currentYear = new Date().getFullYear();
                                    var startYear = 1500;
                                    for (var year = currentYear; year >= startYear; year--) {
                                        document.write('<option value="' + year + '">' + year + '</option>');
                                    }
                                </script> *@
                            </select>
                        </div>
                </div>

                <div class="form-row">
                    <!--Số lượng-->
                    <div class="form-group col">
                        <label>Số lượng:</label>
                        <input type="number" class="form-control" id="inputSoLuongModal" onkeydown="validateInput(event, inputSoLuongModal)">
                    </div>

                    <!--Giá sách-->
                    <div class="form-group col">
                        <label>Giá / 1 sách:</label>
                        <input type="number" class="form-control" id="inputGiaSachModal" onkeydown="validateInput(event, inputGiaSachModal)">
                    </div>
                </div>

                <div class="form-row">
                    <!-- Hiển thị hình ảnh -->
                    <div class="form-group">
                        <label>Hình ảnh:</label>
                        <input type="file" class="form-control-file" id="inputHinhAnhModal" accept="image/*" onchange="hienThiAnh()">
                        <img id="hinhAnhPreview" class="img-fluid mt-2" style="max-height: 200px;" alt="Hình ảnh preview">
                    </div>


                    <!-- Mô tả -->
                    <div class="form-group col">
                        <label>Mô tả:</label>
                        <textarea class="form-control" id="inputMoTaModal" rows="3"></textarea>
                    </div>
                </div>

            </form>

            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"> Đóng </button>
                <button type="button" class="btn btn-primary" onclick="themSachMoi()"> Thêm sách </button>
            </div>

        </div>
    </div>
</div>

<!-- Modal hiển thị PDF -->
<div class="modal fade" id="ModalPDF" tabindex="-1" aria-labelledby="ModalPDFLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalPDFLabel">Phieu Tra PDF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <iframe id="pdfIframe" src="" width="100%" height="650px"></iframe>
            </div>
        </div>
    </div>
</div>
<!-- Modal nhập số lượng và giá để thêm such có sẵn-->
<div class="modal fade" id="ThemSachCoSanModal" tabindex="-1" role="dialog" aria-labelledby="ThemSachCoSanModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-primary col-8" style="font-weight:bold;">Nhập thông tin</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label class="col-form-label">Số lượng sách muốn nhập thêm:</label>
                        <input type="number" class="form-control" id="SoLuongSachThemModal" name="SoLuongSachThemModal" placeholder="Nhập số lượng" onkeydown="validateInput(event, SoLuongSachThemModal)">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">Giá sách của 1 cuốn:</label>
                        <input type="number" class="form-control" id="GiaSachThemModal" name="GiaSachThemModal" placeholder="Nhập giá 1 cuốn" onkeydown="validateInput(event, GiaSachThemModal)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="themSachCoSan()">Thêm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm nhà cung cấp-->
<div class="modal fade" id="ThemNccModal" tabindex="-1" role="dialog" aria-labelledby="ThemNccModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-primary col-8" style="font-weight:bold;">Thêm Nhà Cung Cấp</h4>
                <div class="col-3">
                    <button type="button" class="btn btn-warning lamMoiSach" id="lamMoiButtonModal" onclick="LamMoiNCC()">Làm mới</button>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label class="col-form-label">Tên nhà cung cấp:</label>
                        <input type="text" class="form-control" id="TenNccModal">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">Số điện thoại:</label>
                        <input type="text" class="form-control" id="SdtNccModal" onkeydown="validateInput(event, SdtNccModal)">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">Địa chỉ:</label>
                        <input type="text" class="form-control" id="DiaChiNccModal">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="btnThemNCC()">Thêm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal error-->
<div class="modal fade" id="ModalError" tabindex="-1" role="dialog" aria-labelledby="ModalError" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center bg-danger">
                <span class="" id="contentModalError"></span>
            </div>
        </div>
    </div>
</div>

<!-- Modal success-->
<div class="modal fade" id="ModalSuccess" tabindex="-1" role="dialog" aria-labelledby="ModalSuccess" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center bg-green">
                <span class="" id="contentModalSuccess"></span>
            </div>
        </div>
    </div>
</div>
<!-- Modal Thông Báo -->
<div class="modal fade" id="notificationModal" tabindex="-1" role="dialog" aria-labelledby="notificationModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center bg-warning text-white">
                <span id="notificationMessage"></span>
            </div>
        </div>
    </div>
</div>

<!-- Modal Xác nhận tạo phiếu nhập import-->

<div id="confirmationModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="background-color: #f8f9fa; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">
            <div class="modal-header" style="background-color: #007bff; color: white; border-top-left-radius: 10px; border-top-right-radius: 10px;">
                <h5 class="modal-title" id="confirmationModalLabel" style="font-weight: bold; font-size: 1.5rem;">Xác Nhận</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white; opacity: 1;">
                    <span aria-hidden="true" style="color: white;">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="font-size: 1rem; line-height: 1.6; color: #495057;">
                <p id="confirmationMessage">Bạn có chắc chắn muốn thực hiện hành động này?</p>
            </div>
            <div class="modal-footer" style="background-color: #e9ecef; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" style="background-color: #6c757d; border-color: #6c757d;">Hủy</button>
                <button type="button" id="confirmButton" class="btn btn-primary" style="background-color: #007bff; border-color: #007bff;"
                        onmouseover="this.style.backgroundColor='#0056b3';"
                        onmouseout="this.style.backgroundColor='#007bff';">
                    Xác Nhận
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal confirm -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="xacNhanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="xacNhanModalLabel">Xác nhận hành động</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <span class="" id="contentModalConfirm"></span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"> Đóng </button>
                <button type="button" class="btn btn-primary" id="confirmButton1">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
@section scripts
{
    <script>
      
        var listSachNhap = [];
        //khong cho nhap chu
        function validateInput(event, maxQuantity) {
            // Prevent input of non-numeric characters
            if (!isNumericInput(event)) {
                event.preventDefault();
            }
            // Prevent input of 'e' or 'E'
            if (event.key === 'e' || event.key === 'E') {
                event.preventDefault();
            }
            // Ensure the input is within the allowed range (0 to maxQuantity)
            let inputValue = event.target.value;
            if (inputValue < 0 || inputValue > maxQuantity) {
                event.preventDefault();
            }
        }
        function isNumericInput(event) {
            const key = event.key;
            return (key >= '0' && key <= '9') || key === 'Backspace' || key === 'Delete' || key === 'ArrowLeft' || key === 'ArrowRight';
        }
        
        function init() {
            // Lấy ngày hiện tại
            var currentDate = new Date();

            // Định dạng ngày hiện tại thành chuỗi YYYY-MM-DD
            var formatCurrentDate = currentDate.toISOString().slice(0, 10);

            // Set ngày mượn là ngày hiện tại
            document.getElementById("NgayNhap").value = formatCurrentDate;
            document.getElementById("tongTienPhuThu").value = "0";

            // Mặc định chọn nút "Thông tin đơn vị"
            changeTableShow(thongTinNCCTable, thongTinSachTable);
           // createYearDropdown();
        }
        $(document).ready(function () {
            init();
        });
        function lamMoi() {
            document.getElementById("MaNCC").value = "";
            document.getElementById("TenNCC").value = "";
            document.getElementById("SDT").value = "";
            document.getElementById("DiaChi").value = "";
            document.getElementById("tongTienPhuThu").value = "0";
            listSachNhap = [];
            let danhSachSachNhap = document.getElementById("danhSachSachNhap");
            danhSachSachNhap.innerHTML = "";
            changeTableShow(thongTinNCCTable, thongTinSachTable);

        }

        function LamMoiNCC() {
            document.getElementById("TenNccModal").value = "";
            document.getElementById("SdtNccModal").value = "";
            document.getElementById("DiaChiNccModal").value = "";
        }

        function changeTableShow(tableToShow, tableToHide) {
            tableToShow.style.display = "block";
            tableToHide.style.display = "none";

            if (thongTinNCCTable.style.display == "block" && thongTinSachTable.style.display == "none") {
                loadNCCs();
            }
            if (thongTinSachTable.style.display == "block" && thongTinNCCTable.style.display == "none") {
               // loadDVTLs();
                loadsachs();
            }

        }
        function resetInputModal() {
            // Làm mới các trường input
            document.getElementById("inputTenSachModal").value = '';
            document.getElementById("inputTacGiaModal").value = '';
            document.getElementById("inputNhaXuatBanModal").value = '';
            document.getElementById("inputNamXuatBanModal").value = '';
            document.getElementById("inputSoLuongModal").value = '';
            document.getElementById("inputGiaSachModal").value = '';
            document.getElementById("inputMoTaModal").value = '';

            // Làm mới dropdown
            document.getElementById("inputTheLoaiModal").selectedIndex = 0; // Chọn "Chọn thể loại"
            document.getElementById("inputNgonNguModal").selectedIndex = 0; // Chọn "Chọn ngôn ngữ"

            // Làm mới ảnh và preview
            document.getElementById("inputHinhAnhModal").value = '';
            document.getElementById("hinhAnhPreview").src = '';
        }


        //===================== Hàm show don vi thanh ly =====================
        function loadNCCs() {
            if ($.fn.DataTable.isDataTable('#danhSachNCC')) {
                $('#danhSachNCC').DataTable().clear().destroy();
            }
            $('#danhSachNCC').DataTable(
                {
                    processing: true,
                    serverSide: true,
                    paging: true,
                    searching: true,
                    searchDelay: 700,
                    scrollY: false,
                    iDisplayLength: 4,
                    bLengthChange: false,
                    language: {
                        info: "Hiển thị _START_ đến _END_ của _TOTAL_ mục",
                        lengthMenu: "Hiển thị _MENU_ mục",
                        search: "Tìm kiếm",
                        processing: "Đang tải dữ liệu...",
                        paginate: {
                            previous: "Trước",
                            next: "Tiếp theo",
                            last: "Cuối"
                        }
                    },

                    ajax: {
                        url: "/admin/nhapsach/GetListNCCPaging_APP",

                        type: "POST",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        beforeSend: function () {
                            // Optional: Show loading indicator
                        },
                        data: function (data) {
                            var danhSachNCCA = $("#danhSachNCC").DataTable();
                            var settings = danhSachNCCA.settings();
                            var currentPageIndex = Math.ceil(settings[0]._iDisplayStart / settings[0]._iDisplayLength) + 1;
                            var request = {
                                PageSize: 4,
                                Page: currentPageIndex,
                                Keyword: $('.dt-search input[type="search"]').val()
                            };
                            return JSON.stringify(request);
                        },
                        dataSrc: function (res) {
                            console.log("ket qua NCC: ", res.nccList);

                            if (res.success && res.nccList != null) {
                                return res.nccList.results;
                            } else {
                                return [];
                            }
                        },
                        dataFilter: function (data) {
                            var page = $.parseJSON(data);
                            if (!page.success || page.nccList == null) {
                                page.recordsTotal = 0;
                                page.recordsFiltered = 0;
                                return JSON.stringify(page);
                            }
                            page.recordsTotal = page.nccList.rowCount || 0;
                            page.recordsFiltered = page.nccList.rowCount || 0;
                            return JSON.stringify(page);
                        },
                        error: function (status) {
                            // Handle error
                        }
                    },
                    columns: [
                        { data: "mancc", width: "15%" },
                        { data: "tenncc", width: "25%" },
                        { data: "sdtncc", width: "25%" },
                        { data: "diachincc", width: "35% " },

                    ],
                    columnDefs: [{
                        "defaultContent": "-",
                        "targets": "_all"
                    }]
                });
        }

        $('body').on('click', '#danhSachNCC tbody tr', function () {
            // Lấy DataTable
            var table = $('#danhSachNCC').DataTable();

            // Lấy dữ liệu của hàng được click
            var rowData = table.row(this).data();
            document.getElementById("MaNCC").value = rowData.mancc;
            document.getElementById("TenNCC").value = rowData.tenncc;
            document.getElementById("SDT").value = rowData.sdtncc;
            document.getElementById("DiaChi").value = rowData.diachincc;

        });
        
        function loadsachs() {
            if ($.fn.DataTable.isDataTable('#danhSachSach')) {
                $('#danhSachSach').DataTable().clear().destroy();
            }
            $('#danhSachSach').DataTable(
                {
                    processing: true,
                    serverSide: true,
                    paging: true,
                    searching: true,
                    searchDelay: 700,
                    scrollY: false,
                    iDisplayLength: 6,
                    bLengthChange: false,
                    language: {
                        info: "Hiển thị _START_ đến _END_ của _TOTAL_ mục",
                        lengthMenu: "Hiển thị _MENU_ mục",
                        search: "Tìm kiếm",
                        processing: "Đang tải dữ liệu...",
                        paginate: {
                            previous: "Trước",
                            next: "Tiếp theo",
                            last: "Cuối"
                        }
                    },

                    ajax: {
                        url: "/admin/nhapsach/GetListSachPaging_APP",

                        type: "POST",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        beforeSend: function () {
                            // Optional: Show loading indicator
                        },
                        data: function (data) {
                            var danhSachSachA = $("#danhSachSach").DataTable();
                            var settings = danhSachSachA.settings();
                            var currentPageIndex = Math.ceil(settings[0]._iDisplayStart / settings[0]._iDisplayLength) + 1;
                            var request = {
                                PageSize: 6,
                                Page: currentPageIndex,
                                Keyword: $('.dt-search input[type="search"]').val()
                            };
                            return JSON.stringify(request);
                        },
                        dataSrc: function (res) {
                            thongTinSachTableDatas = res.sachList.results;

                            console.log("ket qua sach: ", res.sachList);

                            if (res.success && res.sachList != null) {

                                return res.sachList.results;
                            } else {
                                return [];
                            }
                        },
                        dataFilter: function (data) {
                            var page = $.parseJSON(data);
                            if (!page.success || page.sachList == null) {
                                page.recordsTotal = 0;
                                page.recordsFiltered = 0;
                                return JSON.stringify(page);
                            }
                            page.recordsTotal = page.sachList.rowCount || 0;
                            page.recordsFiltered = page.sachList.rowCount || 0;
                            return JSON.stringify(page);
                        },
                        error: function (status) {
                            // Handle error
                        }

                    },
                    columns: [
                        { name: 'first', data: "masach", width: "25%" },
                        { data: "tensach", width: "55%" },
                        {
                            className: 'dt-control',
                            orderable: false,
                            data: null,
                            defaultContent: ''
                        }
                       
                    ],
                    rowGroup: {
                        endRender: function (rows, group) {
                            return group + ' (' + rows.count() + ' rows)';
                        }
                    },
                    columnDefs: [{

                        "defaultContent": "-",
                        "targets": "_all"
                    }]
                });
            $('#danhSachSach').on('click', 'td.dt-control', function () {
                $("#showChiTietSachModal").modal("show");

                var rowData = $('#danhSachSach').DataTable().row($(this).closest('tr')).data();

                $("#maSachModal").val(rowData.masach);
                $("#tenSachModal").val(rowData.tensach);
                $("#theLoaiModal").val(rowData.theloai);
                $("#tacGiaModal").val(rowData.tacgia);
                $("#nhaXuatBanModal").val(rowData.nxb);
                $("#namXuatBanModal").val(rowData.namxb);
                $("#ngonNguModal").val(rowData.ngonngu);
                $("#soLuongHienTaiModal").val(rowData.soluonghientai);
              
            });
        }

        function nhapThemSoLuongVaGiaSach() {
            // Lấy dữ liệu sách từ modal chi tiết
            var maSach = $("#maSachModal").val();
            var namXB = $("#namXuatBanModal").val();
            var currentYear = new Date().getFullYear();

            // Gọi API lấy NamXBMax
            $.ajax({
                url: "/admin/nhapsach/GetNamXBMax_APP",
                type: 'POST',
                success: function (response) {
                    if (response.success && response.namXBMax) {
                        var namXBMax = response.namXBMax;

                        // Kiểm tra điều kiện (năm hiện tại - năm xuất bản) <= namXBMax
                        var yearDiff = currentYear - namXB;

                        if (yearDiff > namXBMax) {
                            // Hiển thị modal thông báo nếu sách đã quá cũ
                            $("#notificationMessage").text("Sách đã quá cũ. Vui lòng nhập sách mới hơn.");
                            $("#notificationModal").modal("show");
                        } else {
                            // Nếu thỏa mãn điều kiện, mở modal Thêm Sách Có Sẵn
                            document.getElementById("SoLuongSachThemModal").value = "";
                            document.getElementById("GiaSachThemModal").value = "";
                            $("#ThemSachCoSanModal").modal("show");
                        }
                    } else {
                        console.log("API không trả về NamXBMax hợp lệ");
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Lỗi khi lấy NamXBMax từ API:", error);
                }
            });
        }

        //=====================  btn Thêm Sách sẵn  =====================
        function themSachCoSan() {
            ThemSachV2(
                "maSachModal", "tenSachModal", "theLoaiModal",
                "ngonNguModal", "tacGiaModal", "nhaXuatBanModal",
                "namXuatBanModal", "SoLuongSachThemModal", "GiaSachThemModal"
            );
           
        }

        //===================== show view Thêm sách mới =====================
        function showInputThemSachMoi() {
            document.getElementById("inputTenSachModal").value = "";
            document.getElementById("inputTheLoaiModal").value = "Chọn thể loại";
            document.getElementById("inputNgonNguModal").value = "Chọn ngôn ngữ";
            document.getElementById("inputTacGiaModal").value = "";
            document.getElementById("inputNhaXuatBanModal").value = "";
            document.getElementById("inputNamXuatBanModal").value = "Chọn năm xuất bản";

            document.getElementById("inputSoLuongModal").value = "";
            document.getElementById("inputGiaSachModal").value = "";
            $("#inputSachModal").modal("show");
            createYearDropdown();
          
        }
        //=====================  btn Thêm Sách mới  =====================
        function themSachMoi() {
            ThemSachV2(
                "", "inputTenSachModal", "inputTheLoaiModal",
                "inputNgonNguModal", "inputTacGiaModal", "inputNhaXuatBanModal",
                "inputNamXuatBanModal", "inputSoLuongModal", "inputGiaSachModal"
            );
            
        }

        function hienThiAnh() {
            var input = document.getElementById('inputHinhAnhModal');
            var imgPreview = document.getElementById('hinhAnhPreview');

            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    imgPreview.src = e.target.result;
                };

                reader.readAsDataURL(input.files[0]);
            }
        }

        var maSachMoi = -1;

        function ThemSachV2(idMaSach, idTenSach, idTheLoai, idNgonNgu, idTacGia, idNhaXB, idNamXB, idSoLuong, idGiaSach) {
            var maSach
            idMaSach == "maSachModal" ? maSach = document.getElementById(idMaSach).value : maSach = maSachMoi--;
            var tenSach = document.getElementById(idTenSach).value;
            var theLoai = document.getElementById(idTheLoai).value;
            var ngonNgu = document.getElementById(idNgonNgu).value;
            var tacGia = document.getElementById(idTacGia).value;
            var nhaXB = document.getElementById(idNhaXB).value;
            var namXB = document.getElementById(idNamXB).value;

            var soLuong = document.getElementById(idSoLuong).value;
            var giaSach = document.getElementById(idGiaSach).value;

            if (!tenSach.trim() || theLoai === "Chọn thể loại" || ngonNgu === "Chọn ngôn ngữ" || !tacGia.trim() || !nhaXB.trim() || !namXB.trim()) {
                document.getElementById("contentModalError").innerHTML = "Hãy nhập đủ thông tin sách!";
                $("#ModalError").modal("show");
            } else if (!Number.isInteger(Number(soLuong)) || soLuong <= 0) {
                document.getElementById("contentModalError").innerHTML = "Hãy nhập đúng số lượng sách nhập!";
                $("#ModalError").modal("show");
            } else if (isNaN(giaSach) || giaSach <= 0) {
                document.getElementById("contentModalError").innerHTML = "Hãy nhập đúng giá sách!";
                $("#ModalError").modal("show");
            } else {
                if (maSach < 0) { //sach mới
                    var input = document.getElementById('inputHinhAnhModal');
                    var moTa = document.getElementById("inputMoTaModal").value;

                    if (!input.files || !input.files[0]) {
                        document.getElementById("contentModalError").innerHTML = "Hãy chọn ảnh sách!";
                        $("#ModalError").modal("show");
                    } else if (!moTa.trim()) {
                        document.getElementById("contentModalError").innerHTML = "Hãy nhập mô tả sách!";
                        $("#ModalError").modal("show");
                    } else {
                        var file = input.files[0];
                      

                        var index = listSachNhap.findIndex((element) => element.maSach == maSach);
                        if (index == -1) { // không tìm thấy
                           
                            var newSach = {
                                maSach: maSach,
                                tenSach: tenSach,
                                theLoai: theLoai,
                                tacGia: tacGia,
                                nhaXB: nhaXB,
                                namXB: namXB,
                                soLuong: soLuong,
                                giaSach: giaSach,
                                ngonNgu: ngonNgu,
                                fileImage: file,
                                moTa: moTa,
                               ThanhTien: giaSach * soLuong // Tính tổng giá tiền
                            };
                            listSachNhap.push(newSach);
                            console.log("sach nhap nhap moi 1 : ", listSachNhap);
                        } else {

                            listSachNhap[index].giaSach = giaSach;
                            listSachNhap[index].soLuong = soLuong;
                            listSachNhap[index].ThanhTien += giaSach * soLuong; // Cập nhật tổng giá tiền
                            console.log("sach nhap moi 2 : ", listSachNhap);
                        }
                    }
                } else { // sach có sẵn
                    var index = listSachNhap.findIndex((element) => element.maSach == maSach);
                    if (index == -1) { // không tìm thấy
                       
                        var newSach = {
                            maSach: maSach,
                            tenSach: tenSach,
                            theLoai: theLoai,
                            tacGia: tacGia,
                            nhaXB: nhaXB,
                            namXB: namXB,
                            soLuong: soLuong,
                            giaSach: giaSach,
                            ngonNgu: ngonNgu,
                            ThanhTien: giaSach * soLuong // Tính tổng giá tiền
                        };
                        listSachNhap.push(newSach);
                        console.log("sach nhap co san 1 : ", listSachNhap);
                    } else {

                        listSachNhap[index].giaSach = giaSach;
                        listSachNhap[index].soLuong = soLuong;
                       listSachNhap[index].ThanhTien += giaSach * soLuong; // Cập nhật tổng giá tiền
                        console.log("sach nhap co san 2 : ",listSachNhap);
                    }
                }
                $("#inputSachModal").modal("hide");
                $("#ThemSachCoSanModal").modal("hide");
                $("#showChiTietSachModal").modal("hide");
                    renderListSachNhap();
                updateTongTien();
                resetInputModal(); // Gọi hàm làm mới modal

            }
        }

        function renderListSachNhap() {
            var danhSachSachNhap = $("#danhSachSachNhap");
            // Xóa nội dung bảng
            danhSachSachNhap.empty();
            $.each(listSachNhap, function (index, item) {
                //var masachCell = item.maSach < 0 ? 'New' : item.maSach;
                var newRow = $(`
                                  <tr class="sachNhap-row" data-ma-sach="${item.maSach}">
                                    <td>${item.maSach < 0 ? 'New' : item.maSach}</td>
                                    <td>${item.tenSach}</td>
                                    <td>${item.theLoai}</td>
                                    <td>${item.tacGia}</td>
                                    <td>${item.ngonNgu}</td>
                                    <td>${item.nhaXB}</td>
                                    <td>${item.namXB}</td>
                                    <td>${item.soLuong}</td>
                                    <td>${item.giaSach}</td>
                                    <td>
                                      <button type="button" class="btn btn-danger xoaSachNhap" id="xoaSachNhap" onclick="xoaSachNhapV2('${item.maSach}')">Xóa</button>
                                    </td>
                                  </tr>
                                `);


                danhSachSachNhap.append(newRow);
            });
        }


        function xoaSachNhapV2(maSach) {
            // Tính giá trị index
            const index = listSachNhap.findIndex((element) => element.maSach == maSach);

            // Nếu sách tồn tại trong danh sách
            if (index !== -1) {
                // Hiển thị nội dung xác nhận
                document.getElementById("contentModalConfirm").textContent = "Bạn có chắc chắn muốn xóa sách này khỏi danh sách nhập?";

                // Hiển thị modal xác nhận
                const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
                modal.show();

                // Lắng nghe sự kiện "Xác nhận"
                const confirmButton = document.getElementById("confirmButton1");
                confirmButton.onclick = function () {
                    // Xóa sách khỏi danh sách
                    listSachNhap.splice(index, 1);
                    renderListSachNhap();
                    console.log("Danh sách sau khi xóa: ", listSachNhap);
                    updateTongTien();

                    // Ẩn modal sau khi thực hiện xong
                    modal.hide();
                };
            }
        }



        //===================== Hàm show modal nha cung cap  =====================
        function btnShowModalThemNCC() {
            $("#ThemNccModal").modal("show");
        }

        function btnThemNCC() {
            var tenNcc = document.getElementById("TenNccModal").value;
            var sdtNcc = document.getElementById("SdtNccModal").value;
            var diaChiNcc = document.getElementById("DiaChiNccModal").value;

            var nccValues = {
                TenNcc: tenNcc,
                SdtNcc: sdtNcc,
                DiaChiNcc: diaChiNcc
            };

            if (!tenNcc || !sdtNcc || !diaChiNcc) {
                document.getElementById("contentModalError").innerHTML = "Thông tin nhà cung cấp  không được để trống!";
                $("#ModalError").modal("show");
            } else {
                var phoneRegex = /^\d{10,11}$/;
                if (!phoneRegex.test(sdtNcc)) {
                    document.getElementById("contentModalError").innerHTML = "Hãy nhập đúng định dạng số điện thoại!";
                    $("#ModalError").modal("show");
                } else {
                    document.getElementById("contentModalConfirm").innerHTML = "Bạn có chắc muốn thêm nhà cung cấp không?";
                    const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
                    modal.show();

                    // Lắng nghe sự kiện xác nhận
                    const confirmButton = document.getElementById("confirmButton1");
                    confirmButton.onclick = function () {
                    // var confirmed = confirm("Bạn có chắc muốn thêm nhà cung cấp không?");
                    // if (confirmed) {
                        $.ajax({
                            url: "/admin/nhapsach/ThemNCC_APP",
                            type: 'POST',
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify(nccValues),
                            success: function (response) {
                                if (response.success) {
                                    document.getElementById("TenNccModal").value = "";
                                    document.getElementById("SdtNccModal").value = "";
                                    document.getElementById("DiaChiNccModal").value = "";

                                    document.getElementById("contentModalSuccess").innerHTML = "Thêm đơn vị thành công";
                                    $("#ModalSuccess").modal("show");
                                    $("#ThemNccModal").modal("hide");
                                    loadNCCs();
                                    console.log("ncc: ", response);
                                    // Đóng modal xác nhận
                                    modal.hide();

                                } else {

                                    document.getElementById("contentModalError").innerHTML = response.message;
                                    $("#ModalError").modal("show");
                                }
                            },
                            error: function () {
                                alert("Lỗi khi gửi yêu cầu đến máy chủ.");
                            }
                        });
                    }
                }
            }
        }

        function taoPhieuNhap() {
            var maNCC = document.getElementById("MaNCC").value;
            var tenNCC = document.getElementById("TenNCC").value.trim();
            var maNhanVien = document.getElementById("MaNhanVien").value;
            var ngayNhap = document.getElementById("NgayNhap").value;
            console.log(document.getElementById("TenNCC").value);
            if (!maNCC) {
                $("#notificationMessage").text("Vui lòng chọn nhà cung cấp.");
                $("#notificationModal").modal("show");
                return;
            }
            if (!tenNCC) {
                $("#notificationMessage").text("Không thể lấy tên nhà cung cấp. Vui lòng kiểm tra lại.");
                $("#notificationModal").modal("show");
                return;
            }
            if (listSachNhap == null || listSachNhap.length == 0) {
                $("#notificationMessage").text("Vui lòng chọn sách nhập.");
                $("#notificationModal").modal("show");
                return;
            }
            var formData = new FormData();
            formData.append('MaNhaCungCap', maNCC);
            formData.append('TenNhaCungCap', tenNCC);
            formData.append('MaNhanVien', maNhanVien);
            formData.append('NgayNhap', ngayNhap);
            listSachNhap.forEach((item, index) => {
                formData.append(`listSachNhap[${index}].maSach`, item.maSach);
                formData.append(`listSachNhap[${index}].tenSach`, item.tenSach);
                formData.append(`listSachNhap[${index}].theLoai`, item.theLoai);
                formData.append(`listSachNhap[${index}].ngonNgu`, item.ngonNgu);
                formData.append(`listSachNhap[${index}].tacGia`, item.tacGia);
                formData.append(`listSachNhap[${index}].nhaXB`, item.nhaXB);
                formData.append(`listSachNhap[${index}].soLuong`, item.soLuong);
                formData.append(`listSachNhap[${index}].namXB`, item.namXB);
                formData.append(`listSachNhap[${index}].giaSach`, item.giaSach);
                formData.append(`listSachNhap[${index}].fileImage`, item.fileImage);
                formData.append(`listSachNhap[${index}].moTa`, item.moTa);
            });

            document.getElementById("contentModalConfirm").innerHTML = "Bạn có chắc muốn tạo phiếu nhập không ? ";
            const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
            modal.show();

            // Lắng nghe sự kiện xác nhận
            const confirmButton = document.getElementById("confirmButton1");
            confirmButton.onclick = function () {
            // var confirmed = confirm("Bạn có chắc muốn tạo phiếu nhập không?");
            // if (confirmed) {
                $.ajax({
                    type: "POST",
                    url: "/admin/nhapsach/PhieuNhap_APP",
                    contentType: false,
                    processData: false,
                    data: formData,
                    success: function (response, status, xhr) {
                        if (xhr.getResponseHeader('Content-Type') === 'application/pdf') {
                            var pdfBlob = new Blob([response], { type: 'application/pdf' });
                            var pdfUrl = URL.createObjectURL(pdfBlob);
                            document.getElementById('pdfIframe').src = pdfUrl;
                            $("#ModalPDF").modal("show");
                            listSachNhap = [];
                            lamMoi();
                            modal.hide(); // Ẩn modal
                        } else {
                            var errorResponse = JSON.parse(response);
                            document.getElementById("contentModalError").innerHTML = errorResponse.message || "Có lỗi xảy ra!";
                            $("#ModalError").modal("show");
                        }
                    },
                    xhrFields: {
                        responseType: 'blob'
                    },
                    error: function () {
                        alert("Lỗi khi gửi yêu cầu đến máy chủ.");
                    }
                });
            }
        }

        function updateTongTien() {
            var tongTienPhuThu = 0;

            // Lặp qua từng phần tử trong mảng sachValues và tính tổng tiền
            listSachNhap.forEach(function (sach) {
                if (!isNaN(sach.ThanhTien)) {
                    tongTienPhuThu += sach.ThanhTien;
                }
            });

            // Hiển thị tổng tiền trong trường "Tổng tiền"
            document.getElementById("tongTienPhuThu").value = formatMoney(tongTienPhuThu);
        }

        // Hàm format tiền
        function formatMoney(number) {
            return number.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function createYearDropdown() {
            var currentYear = new Date().getFullYear(); // Lấy năm hiện tại

            $.ajax({
                url: "/admin/nhapsach/GetNamXBMax_APP",
                type: 'POST',
                success: function (response) {
                    console.log("ket qua nam xb lon nhat" ,response); // Kiểm tra dữ liệu trả về từ API
                    if (response.success && response.namXBMax) {
                        var namMax = response.namXBMax; // Giá trị NamXBMax trả về từ API
                        var selectElement = document.getElementById("inputNamXuatBanModal");

                        // Xóa tất cả các option cũ trong dropdown
                        selectElement.innerHTML = "<option value=''>Chọn năm xuất bản</option>";

                        // Tạo các option từ năm hiện tại đến năm hiện tại trừ đi NamXBMax
                        for (var year = currentYear; year >= (currentYear - namMax); year--) {
                            var option = document.createElement("option");
                            option.value = year;
                            option.textContent = year;
                            selectElement.appendChild(option);
                        }
                    } else {
                        console.log("API không trả về NamXBMax hợp lệ");
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error fetching NamXBMax from API:", error);
                }
            });
        }

        async function uploadExcel() {
            const fileInput = document.getElementById('fileExcel');
            const file = fileInput.files[0];

            if (!file) {
                $("#notificationMessage").text("Vui lòng chọn file Excel!");
                $("#notificationModal").modal("show");
                //alert("Vui lòng chọn file Excel!");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch('/admin/nhapsach/ImportExcel', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`Lỗi từ API: ${response.statusText}`);
                }

                const data = await response.json();
                console.log("Kết quả từ API:", data);

                if (data.errorRecords.length > 0) {
                    // Hiển thị modal thông báo lỗi với danh sách lỗi
                    renderErrorModal(data.errorRecords, "Đã xảy ra lỗi trong quá trình nhập. Vui lòng kiểm tra lại file!");
                } else if (data.successfulRecords.length > 0) {
                    // Hiển thị modal xác nhận nếu không có lỗi và có dữ liệu hợp lệ
                    const message = "Dữ liệu hợp lệ. Bạn có muốn tạo phiếu nhập không?";
                    showConfirmationModal(message, data.successfulRecords);
                } else {
                    $("#notificationMessage").text("Không có dữ liệu hợp lệ hoặc lỗi!");
                    $("#notificationModal").modal("show");
                }
            } catch (err) {
                console.error("Lỗi:", err);
                alert(`Lỗi khi tải lên: ${err.message}`);
            }
        }
        function showConfirmationModal(message, successfulRecords) {
            const modalMessageElement = document.getElementById("confirmationMessage");
            const confirmationModal = $('#confirmationModal');

            if (modalMessageElement) {
                modalMessageElement.textContent = message;
            }

            if (confirmationModal.length) {
                // Gắn sự kiện click vào nút xác nhận với `successfulRecords`
                document.getElementById("confirmButton").onclick = () => createImportReceipt(successfulRecords);
                confirmationModal.modal('show');
            } else {
                console.error("Modal xác nhận với ID 'confirmationModal' không tồn tại!");
            }
        }


        function renderErrorModal(errorRecords, message) {
            const errorListElement = document.getElementById("errorList");
            const errorMessageElement = document.getElementById("errorMessage");

            if (errorMessageElement) {
                errorMessageElement.textContent = message;
            }
            $('#errorModal').modal('show');
        }

        async function createImportReceipt(successfulRecords) {
            try {
                // Kiểm tra nếu `successfulRecords` là một mảng hợp lệ và có ít nhất 1 phần tử
                if (!Array.isArray(successfulRecords) || successfulRecords.length === 0) {
                    $("#notificationMessage").text("Danh sách bản ghi thành công (successfulRecords) rỗng hoặc không hợp lệ!");
                    $("#notificationModal").modal("show");
                   // alert("Danh sách bản ghi thành công (successfulRecords) rỗng hoặc không hợp lệ!");
                    return;
                }

                // Kiểm tra xem mỗi phần tử trong successfulRecords có thuộc tính id không
                const invalidRecords = successfulRecords.filter(record => !record.id);
                if (invalidRecords.length > 0) {
                    $("#notificationMessage").text("Có bản ghi không hợp lệ (thiếu id)!");
                    $("#notificationModal").modal("show");
                  //  alert("Có bản ghi không hợp lệ (thiếu id)!");
                    return;
                }

                // Lấy thông tin từ các trường input
                const maNCC = document.getElementById("MaNCC").value;
                const tenNCC = document.getElementById("TenNCC").value.trim();
                const maNhanVien = document.getElementById("MaNhanVien").value;
                const ngayNhap = document.getElementById("NgayNhap").value;

                if (!maNCC || !tenNCC || !maNhanVien || !ngayNhap) {
                    $("#notificationMessage").text("Vui lòng kiểm tra lại thông tin Nhà cung cấp.");
                    $("#notificationModal").modal("show");
                    return;
                }

                // Tạo danh sách DTO_ID từ successfulRecords
                const idThongTin = successfulRecords.map(record => ({ ID: record.id }));

                // Tạo object DTO_Tao_Phieu_Nhap_Excel
                const requestData = {
                    MaNhanVien: parseInt(maNhanVien, 10),
                    MaNhaCungCap: parseInt(maNCC, 10),
                    TenNhaCungCap: tenNCC,
                    NgayNhap: ngayNhap, // Backend cần xử lý format này
                    idThongTin: idThongTin,
                };

                console.log("Dữ liệu gửi đến API:", requestData);

                const response = await fetch('/admin/nhapsach/PhieuNhap_Excel_APP', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });

                if (!response.ok) {
                    throw new Error(`Lỗi từ API: ${response.statusText}`);
                }

                const result = await response.json();
                console.log("Kết quả từ API:", result);

                if (result.success) {
                    document.getElementById("contentModalSuccess").innerHTML = "Tạo phiếu mượn thành công!";
                    $("#ModalSuccess").modal("show");
                    lamMoi()
                    // Lấy ngày hiện tại
                    var currentDate = new Date();

                    // Định dạng ngày hiện tại thành chuỗi YYYY-MM-DD
                    var formatCurrentDate = currentDate.toISOString().slice(0, 10);

                    // Set ngày mượn là ngày hiện tại
                    document.getElementById("NgayNhap").value = formatCurrentDate;
                    $('#confirmationModal').modal('hide'); // Đóng modal xác nhận
                } else {
                    // Đặt nội dung thông báo lỗi vào modal
                    document.getElementById("contentModalError").innerHTML = `
                <p>Tạo phiếu nhập thất bại:</p>
                <p class="text-danger">${result.message}</p>
            `;
                    $("#ModalError").modal("show");
                }

            } catch (err) {
                console.error("Lỗi khi tạo phiếu nhập:", err);
                alert(`Lỗi khi tạo phiếu nhập: ${err.message}`);
            }
        }

        // Hàm đọc file Excel khi người dùng chọn file
        function docexcel() {
            var input = document.getElementById('fileExcel');
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });

                    var firstSheet = workbook.Sheets[workbook.SheetNames[0]];

                    // Lấy thông tin Lô Nhập Sách
                    var maNCC = firstSheet['A3'] ? firstSheet['A3'].v : ''; // Mã NCC
                    var ngayNhap = firstSheet['B3'] ? firstSheet['B3'].v : ''; // Ngày Nhập

                    // Chuyển đổi định dạng ngày
                    var ngayNhapFormatted = convertDateFormat(ngayNhap);

                    // Gán giá trị vào input
                    document.getElementById('MaNCC').value = maNCC;
                    document.getElementById('NgayNhap').value = ngayNhapFormatted;
                    console.log("Mã nhà cung cấp: ", maNCC);

                    // Kiểm tra thông tin Nhà cung cấp
                    if (maNCC) {
                        layThongTinNCC(maNCC); // Gọi hàm kiểm tra NCC
                    } else {
                        $("#notificationMessage").text("Mã nhà cung cấp không tồn tại trong file Excel.");
                        $("#notificationModal").modal("show");
                        //alert("Mã nhà cung cấp không tồn tại trong file Excel.");
                    }
                };

                reader.onerror = function (error) {
                    console.error("Lỗi khi đọc file:", error);
                    $("#notificationMessage").text("Đã xảy ra lỗi khi đọc file Excel.");
                    $("#notificationModal").modal("show");
                   // alert("Đã xảy ra lỗi khi đọc file Excel.");
                };

                reader.readAsArrayBuffer(input.files[0]);
            }
        }

        // Hàm chuyển đổi định dạng ngày
        function convertDateFormat(date) {
            var parts = date.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return '';
        }

        // Hàm lấy thông tin Nhà Cung Cấp (NCC)
        function layThongTinNCC(maNCC) {
            var requestData = {
                PageSize: 1, // Lấy 1 bản ghi cụ thể
                Page: 1,
                Keyword: maNCC + ""  // Tìm kiếm theo mã NCC
            };

            console.log("Dữ liệu gửi lên API:", requestData);

            $.ajax({
                url: "/admin/nhapsach/GetListNCCPaging_APP",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(requestData),
                success: function (res) {
                    console.log("Dữ liệu trả về từ API:", res);

                    if (res && res.success && res.nccList && res.nccList.results && res.nccList.results.length > 0) {
                        var ncc = res.nccList.results[0];
                        console.log("Thông tin NCC:", ncc);

                        // Hiển thị thông tin NCC lên giao diện
                        document.getElementById('TenNCC').value = ncc.tenncc || '';
                        document.getElementById('DiaChi').value = ncc.diachincc || '';
                        document.getElementById('SDT').value = ncc.sdtncc || '';
                    } else {
                        console.warn("API trả về kết quả trống hoặc không thành công.");
                        $("#notificationMessage").text("Nhà cung cấp không tồn tại trong hệ thống.");
                        $("#notificationModal").modal("show");
                        //alert("Nhà cung cấp không tồn tại trong hệ thống.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Lỗi khi gọi API:", error, xhr.responseText);
                    alert("Đã xảy ra lỗi khi kiểm tra nhà cung cấp.");
                }
            });
        }

        // Gắn sự kiện 'change' vào input file
        document.getElementById('fileExcel').addEventListener('change', function () {
            docexcel();  // Gọi hàm docexcel khi chọn file
        });
        document.querySelector('.btn-secondary').addEventListener('click', function () {
            $('#errorModal').modal('hide');

        });

    </script>
}